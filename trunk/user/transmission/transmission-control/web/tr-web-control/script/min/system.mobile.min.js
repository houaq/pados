/*
	移动版
*/
var system={version:"1.0 Beta",rootPath:"tr-web-control/",codeupdate:"20141010",config:{autoReload:!0,reloadStep:5e3,pageSize:30,defaultSelectNode:null},lang:null,reloading:!1,autoReloadTimer:null,downloadDir:"",islocal:!1,B64:new Base64,currentTorrentId:0,currentContentPage:"home",currentContentConfig:null,control:{tree:null,torrentlist:null},serverConfig:null,serverSessionStats:null,torrentListChecked:!1,debug:function(t,e){window.console&&window.console.log&&window.console.log(t,e)},setlang:function(t,e){t||(t=this.config.defaultLang?this.config.defaultLang:navigator.language||navigator.browserLanguage),t||(t="zh-CN"),t.indexOf("-")!=-1&&(t=t.split("-")[0].toLocaleLowerCase()+"-"+t.split("-")[1].toLocaleUpperCase()),this.languages[t]||(t="en"),$.getScript(system.rootPath+"lang/"+t+".js",function(){system.lang=$.extend(!0,system.defaultLang,system.lang),system.resetLangText(),e&&e()})},resetLangText:function(){var items=$("*[system-lang]")
$.each(items,function(key,item){var name=$(item).attr("system-lang")
$(item).html(eval("system.lang."+name))})},init:function(t,e){this.readConfig(),transmission.options.getFolders=!1,null==this.lang?this.setlang(t,function(){system.initdata()}):this.initdata()},initdata:function(){$(document).attr("title",this.lang.system.title+" "+this.version),this.control.torrentlist=$("#torrent-list"),this.connect()},readConfig:function(){var t=cookies.get("transmission-web-control")
$.isPlainObject(t)&&(this.config=$.extend(this.config,t))},saveConfig:function(){cookies.set("transmission-web-control",this.config,100)},connect:function(){transmission.on.torrentCountChange=function(){system.reloadTorrentBaseInfos()},transmission.on.postError=function(){},transmission.init({islocal:!0},function(){system.reloadSession(!0),system.getServerStatus()})},reloadSession:function(t){transmission.getSession(function(t){system.serverConfig=t,1==t["alt-speed-enabled"]?$("#status_alt_speed").show():$("#status_alt_speed").hide(),system.downloadDir=t["download-dir"],parseInt(system.serverConfig["rpc-version"])>=15?transmission.getFreeSpace(system.downloadDir,function(t){system.serverConfig["download-dir-free-space"]=t.arguments["size-bytes"],system.showFreeSpace(t.arguments["size-bytes"])}):system.showFreeSpace(system.serverConfig["download-dir-free-space"])})},showFreeSpace:function(t){var e=t
e=e==-1?system.lang.public["text-unknown"]:formatSize(e),$("#status_freespace").text(e)},getServerStatus:function(){this.reloading||(clearTimeout(this.autoReloadTimer),this.reloading=!0,transmission.getStatus(function(t){system.reloading=!1,$("#status_downloadspeed").html(formatSize(t.downloadSpeed,!1,"speed")),$("#status_uploadspeed").html(formatSize(t.uploadSpeed,!1,"speed")),system.serverSessionStats=t}))},reloadTorrentBaseInfos:function(t){if(!this.reloading){clearTimeout(this.autoReloadTimer),this.reloading=!0
var e={trackers:transmission.trackers,folders:transmission.torrents.folders}
transmission.torrents.getallids(function(t){var s=new Array
for(var n in t){var r=t[n]
s.push(r.id)}var a=transmission.torrents.getErrorIds(s,!0)
a.length>0?transmission.torrents.getallids(function(){system.resetTorrentInfos(e)},a):system.resetTorrentInfos(e)},t)}},resetTorrentInfos:function(t){this.currentTorrentId
if(transmission.torrents.status[transmission._status.stopped]?this.updateCount("paused",transmission.torrents.status[transmission._status.stopped].length):this.updateCount("paused",0),transmission.torrents.status[transmission._status.seed]?this.updateCount("sending",transmission.torrents.status[transmission._status.seed].length):this.updateCount("sending",0),transmission.torrents.status[transmission._status.check]?this.updateCount("check",transmission.torrents.status[transmission._status.check].length):this.updateCount("check",0),transmission.torrents.status[transmission._status.download]?this.updateCount("downloading",transmission.torrents.status[transmission._status.download].length):this.updateCount("downloading",0),this.updateCount("actively",transmission.torrents.actively.length),this.updateCount("error",transmission.torrents.error.length),this.updateCount("warning",transmission.torrents.warning.length),system.reloading=!1,system.config.autoReload&&(system.autoReloadTimer=setTimeout(function(){system.reloadData()},system.config.reloadStep)),this.updateCount("all",transmission.torrents.count),"torrent-list"==this.currentContentPage){var e=this.currentContentConfig
e.reload=!0,this.showContent(e)}},updateCount:function(t,e){var s=$("#count-"+t)
s.text(e),0==e?s.hide():s.show()},reloadData:function(){this.reloadSession(),this.reloading=!1,this.getServerStatus(),this.reloading=!1,this.reloadTorrentBaseInfos()},showContent:function(t){var e={page:"",type:"",data:"",title:this.lang.system.title,reload:!1,callback:null},s=null
if("string"==typeof t?(e.page=t,s=e):s=jQuery.extend(e,t),s.page!=this.currentContentPage||s.reload){switch($("#content-"+s.page).show(),s.page!=this.currentContentPage&&($("#content-"+this.currentContentPage).hide(),this.control.torrentlist.find("input:checked").prop("checked",!1).checkboxradio("refresh"),this.torrentListChecked=!1),$("#torrent-page-bar").hide(),this.torrentListChecked||$("#torrent-toolbar").hide(),this.currentContentPage=s.page,s.type){case"torrent-list":s.title=this.lang.tree[s.data],this.loadTorrentToList({target:s.data})}$("#page-title").text(s.title),s.reload=!1,this.currentContentConfig=s,s.callback&&s.callback()}},getTorrentFromType:function(t){var e=null
switch(t){case"torrent-all":case"all":case"servers":e=transmission.torrents.all
break
case"paused":e=transmission.torrents.status[transmission._status.stopped]
break
case"sending":e=transmission.torrents.status[transmission._status.seed]
break
case"seedwait":e=transmission.torrents.status[transmission._status.seedwait]
break
case"check":e=transmission.torrents.status[transmission._status.check]
break
case"checkwait":e=transmission.torrents.status[transmission._status.checkwait]
break
case"downloading":e=transmission.torrents.status[transmission._status.download]
break
case"downloadwait":e=transmission.torrents.status[transmission._status.downloadwait]
break
case"actively":e=transmission.torrents.actively
break
case"error":e=transmission.torrents.error
break
case"warning":e=transmission.torrents.warning
break
case"search-result":e=transmission.torrents.searchResult}return e},loadTorrentToList:function(t){if(!this.torrentListChecked&&transmission.torrents.all){var e={node:null,page:1,target:"all"}
if(jQuery.extend(e,t),t.target){var s=this.getTorrentFromType(t.target)
this.config.defaultSelectNode=t.target,this.saveConfig()
var n=new Array
this.control.torrentlist.empty()
for(var r in s)if(s[r]){var a=parseFloat(100*s[r].percentDone).toFixed(2),o=this.lang.torrent["status-text"][s[r].status]
0!=s[r].error?o="<span class='text-status-error'>"+o+"</span>":s[r].warning&&(o="<span class='text-status-warning' title='"+s[r].warning+"'>"+o+"</span>")
var i={id:s[r].id,name:this.getTorrentNameBar(s[r]),totalSize:s[r].totalSize,percentDone:this.getTorrentProgressBar(a,s[r]),percentDoneNumber:a,status:o,addedDate:formatLongTime(s[r].addedDate),completeSize:s[r].totalSize-s[r].leftUntilDone,rateDownload:s[r].rateDownload,rateUpload:s[r].rateUpload,leecherCount:s[r].leecher,seederCount:s[r].seeder,uploadRatio:s[r].uploadRatio,uploadedEver:s[r].uploadedEver}
n.push(i)}if(0==n.length)return void setTimeout(function(){system.showContent("home")},100)
null==this.torrentPager.onGotoPage&&(this.torrentPager.onGotoPage=function(t){system.control.torrentlist.empty(),$("#torrent-toolbar").hide()
for(var e in t)system.appendTorrentToList(t[e])
$(system.control.torrentlist).listview("refresh").find("input[type='checkbox']").click(function(){system.changeTorrentToolbar(this,i),system.torrentListChecked?system.control.torrentlist.find("a[name='torrent']").css("marginLeft","0px"):system.control.torrentlist.find("a[name='torrent']").css("marginLeft","-35px")}).checkboxradio()}),this.torrentPager.setDatas(n,t.target)}}},appendTorrentToList:function(t){var e={id:t.id,name:t.name,rateDownload:formatSize(t.rateDownload,!1,"speed"),rateUpload:formatSize(t.rateUpload,!1,"speed"),completeSize:formatSize(t.completeSize),totalSize:formatSize(t.totalSize),percentDone:t.percentDone},s="<li id='li-torrent-$id$' torrentid='$id$' style='padding:0px;'><a name='torrent' style='padding:0px;margin-left:-35px;'><label data-corners='false' style='margin:0px;border:0px;padding:0px;'><input type='checkbox' id='torrent-$id$'/><label for='torrent-$id$'><h3 style='margin:0px;'>$name$</h3><div style='padding:0px 10px 5px 0px;'>$percentDone$</div><p class='torrent-list-infos'>↓$rateDownload$ ↑$rateUpload$|$completeSize$/$totalSize$</p></label></label></a><a class='more'></a>"
s=s.replace(/\$([^\$]*)\$/g,function(t,s){return e[s]})
var n=$(s)
n.on("swiperight",function(t){system.control.torrentlist.find("a[name='torrent']").css("marginLeft","0px")}),n.on("swipeleft",function(t){system.control.torrentlist.find("a[name='torrent']").css("marginLeft","-35px")}),n.appendTo(this.control.torrentlist)},getTorrentNameBar:function(t){var e="",s=t.name
switch(t.status){case transmission._status.stopped:e="iconlabel icon-pause-small"
break
case transmission._status.check:e="iconlabel icon-checking"
break
case transmission._status.download:e="iconlabel icon-down"
break
case transmission._status.seed:e="iconlabel icon-up"
break
case transmission._status.seedwait:case transmission._status.downloadwait:case transmission._status.checkwait:e="iconlabel icon-wait"}return t.warning&&(e="iconlabel icon-warning-type1",s+="\n\n"+this.lang.public["text-info"]+": "+t.warning),0!=t.error&&(e="iconlabel icon-exclamation",s+="\n\n"+this.lang.public["text-info"]+": "+t.errorString),'<span class="'+e+'" title="'+s+'">'+t.name+"</span>"},getTorrentProgressBar:function(t,e){t+="%"
var s=""
switch(e.status){case transmission._status.stopped:s="torrent-progress-stop"
break
case transmission._status.checkwait:case transmission._status.check:s="torrent-progress-check"
break
case transmission._status.downloadwait:case transmission._status.download:s="torrent-progress-download"
break
case transmission._status.seedwait:case transmission._status.seed:s="torrent-progress-seed"}return e.warning&&(s="torrent-progress-warning"),0!=e.error&&(s="torrent-progress-error"),'<div class="torrent-progress" title="'+t+'"><div class="torrent-progress-text">'+t+'</div><div class="torrent-progress-bar '+s+'" style="width:'+t+';"></div></div>'},changeTorrentToolbar:function(t,e){var s=this.control.torrentlist.find("input:checked")
$("#torrent-checked-count").html(s.length),s.length>0?(this.torrentListChecked=!0,$("#torrent-toolbar").show()):(this.torrentListChecked=!1,$("#torrent-toolbar").hide()),e&&(this.currentTorrentId=e.id)},torrentPager:{datas:null,pageSize:30,pageNumber:0,pageCount:0,count:0,onGotoPage:null,currentDatas:null,pageBar:null,controls:{prev:null,next:null,number:null},head:"",init:function(t){this.pageBar=$("#torrent-page-bar"),this.controls.next=this.pageBar.find("#page-next"),this.controls.next.click(function(){system.torrentPager.gotoPage("next")}),this.controls.prev=this.pageBar.find("#page-prev"),this.controls.prev.click(function(){system.torrentPager.gotoPage("prev")}),this.controls.number=this.pageBar.find("#page-number"),t&&this.setDatas(t)},setDatas:function(t,e){this.datas||this.init(),this.datas=t,this.pageBar.show(),this.count=this.datas.length,this.pageCount=parseInt(this.count/this.pageSize),this.count%this.pageSize>0&&this.pageCount++,1==this.pageCount&&this.pageBar.hide(),this.head==e?this.gotoPage():this.gotoPage(1),this.head=e},gotoPage:function(t){if("number"==typeof t)this.pageNumber=t
else switch(t){case"next":this.pageNumber++
break
case"prev":this.pageNumber--}this.pageNumber>this.pageCount&&(this.pageNumber=this.pageCount),this.pageNumber<1&&(this.pageNumber=1)
var e=(this.pageNumber-1)*parseInt(this.pageSize),s=e+parseInt(this.pageSize)
this.currentDatas=this.datas.slice(e,s),this.controls.number.text(this.pageNumber+"/"+this.pageCount),this.pageNumber>1?this.controls.prev.show():this.controls.prev.hide(),this.pageNumber<this.pageCount?this.controls.next.show():this.controls.next.hide(),this.onGotoPage&&this.onGotoPage(this.currentDatas)}},changeSelectedTorrentStatus:function(t,e,s){var n=this.control.torrentlist.find("input:checked"),r=new Array
t||(t="start")
for(var a=0;a<n.length;a++)r.push(parseInt(n[a].id.replace("torrent-","")))
if(r.length>0){var arguments={ids:r}
switch(t){case"remove":arguments["delete-local-data"]=s.removeData
break
case"verify":if(1==r.length){var o=transmission.torrents.all[r[0]]
if(o.percentDone>0&&0==confirm(system.lang.toolbar.tip["recheck-confirm"]))return}else if(0==confirm(system.lang.toolbar.tip["recheck-confirm"]))return}e=$(e),e.attr("disabled",!0),transmission.exec({method:"torrent-"+t,arguments:arguments},function(t){e.attr("disabled",!1),system.reloadTorrentBaseInfos()}),this.torrentListChecked=!1}},addTorrentsToServer:function(t,e,s,n,r){var a=e-t.length,o=t.shift()
return o?(this.showStatus(this.lang.system.status.queue,e-a+1),void transmission.addTorrentFromUrl(o,n,s,function(a){system.addTorrentsToServer(t,e,s,n,r)})):(this.showStatus(this.lang.system.status.queuefinish),this.getServerStatus(),void(r&&r()))},showStatus:function(t,e){return t?($("#status").show(),$("#status-msg").html(t),void($.isNumeric(e)?$("#status-count").html(e).show():$("#status-count").hide())):void $("#status").hide()}}
$(document).ready(function(){$.getScript(system.rootPath+"lang/default.js"),$.getScript(system.rootPath+"lang/_languages.js",function(){system.init(location.search.getQueryString("lang"))})})
